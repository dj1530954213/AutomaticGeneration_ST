using System;
using System.Collections.Generic;
using System.IO;
using System.Threading.Tasks;
using System.Text;
using System.Diagnostics;
using System.Linq;

namespace WinFormsApp1.Tests
{
    /// <summary>
    /// æµ‹è¯•è¿è¡Œå™¨ - ç»Ÿä¸€ç®¡ç†å’Œæ‰§è¡Œæ‰€æœ‰æµ‹è¯•
    /// </summary>
    public class TestRunner
    {
        #region ç§æœ‰å­—æ®µ

        private readonly List<ITestSuite> _testSuites = new();
        private readonly Dictionary<string, object> _globalTestContext = new();
        private readonly StringBuilder _executionLog = new();
        private string _reportOutputDirectory = "TestReports";

        #endregion

        #region æµ‹è¯•å¥—ä»¶æ¥å£

        /// <summary>
        /// æµ‹è¯•å¥—ä»¶æ¥å£
        /// </summary>
        public interface ITestSuite
        {
            string SuiteName { get; }
            string Description { get; }
            bool IsEnabled { get; set; }
            Task<SystemFunctionalTests.TestSuiteResult> RunTestsAsync();
        }

        #endregion

        #region æµ‹è¯•å¥—ä»¶å®ç°

        /// <summary>
        /// ç³»ç»ŸåŠŸèƒ½æµ‹è¯•å¥—ä»¶
        /// </summary>
        public class FunctionalTestSuite : ITestSuite
        {
            public string SuiteName => "ç³»ç»ŸåŠŸèƒ½æµ‹è¯•";
            public string Description => "STè‡ªåŠ¨ç”Ÿæˆå™¨æ ¸å¿ƒåŠŸèƒ½å®Œæ•´æ€§æµ‹è¯•";
            public bool IsEnabled { get; set; } = true;

            public async Task<SystemFunctionalTests.TestSuiteResult> RunTestsAsync()
            {
                var functionalTests = new SystemFunctionalTests();
                return await functionalTests.RunComprehensiveFunctionalTestsAsync();
            }
        }

        /// <summary>
        /// ç»„åˆè®¾å¤‡ç³»ç»Ÿæµ‹è¯•å¥—ä»¶
        /// </summary>
        public class CompositeDeviceTestSuite : ITestSuite
        {
            public string SuiteName => "ç»„åˆè®¾å¤‡ç³»ç»Ÿæµ‹è¯•";
            public string Description => "ç»„åˆè®¾å¤‡ç®¡ç†å’Œé›†æˆåŠŸèƒ½æµ‹è¯•";
            public bool IsEnabled { get; set; } = true;

            public async Task<SystemFunctionalTests.TestSuiteResult> RunTestsAsync()
            {
                var deviceTests = new CompositeDeviceSystemTests();
                var result = await deviceTests.RunFullTestSuiteAsync();
                
                // è½¬æ¢ç»“æœæ ¼å¼
                return new SystemFunctionalTests.TestSuiteResult
                {
                    SuiteName = SuiteName,
                    TotalTests = result.TotalTests,
                    PassedTests = result.PassedTests,
                    FailedTests = result.FailedTests,
                    TotalDuration = result.TotalDuration,
                    Results = result.Results.Select(r => new SystemFunctionalTests.TestResult
                    {
                        TestSuite = SuiteName,
                        TestName = r.TestName,
                        Success = r.Success,
                        Message = r.Message,
                        Duration = r.Duration,
                        Data = r.Data,
                        Exception = r.Exception,
                        Timestamp = r.Timestamp
                    }).ToList()
                };
            }
        }

        #endregion

        #region äº‹ä»¶å®šä¹‰

        /// <summary>
        /// æµ‹è¯•æ‰§è¡Œè¿›åº¦äº‹ä»¶
        /// </summary>
        public event EventHandler<TestProgressEventArgs>? TestProgress;

        /// <summary>
        /// æµ‹è¯•å¥—ä»¶å®Œæˆäº‹ä»¶
        /// </summary>
        public event EventHandler<TestSuiteCompletedEventArgs>? TestSuiteCompleted;

        /// <summary>
        /// å…¨éƒ¨æµ‹è¯•å®Œæˆäº‹ä»¶
        /// </summary>
        public event EventHandler<AllTestsCompletedEventArgs>? AllTestsCompleted;

        #endregion

        #region äº‹ä»¶å‚æ•°ç±»

        /// <summary>
        /// æµ‹è¯•è¿›åº¦äº‹ä»¶å‚æ•°
        /// </summary>
        public class TestProgressEventArgs : EventArgs
        {
            public string SuiteName { get; set; } = "";
            public string CurrentTest { get; set; } = "";
            public int CompletedTests { get; set; }
            public int TotalTests { get; set; }
            public double ProgressPercentage => TotalTests > 0 ? (double)CompletedTests / TotalTests * 100 : 0;
        }

        /// <summary>
        /// æµ‹è¯•å¥—ä»¶å®Œæˆäº‹ä»¶å‚æ•°
        /// </summary>
        public class TestSuiteCompletedEventArgs : EventArgs
        {
            public SystemFunctionalTests.TestSuiteResult Result { get; set; } = new();
            public TimeSpan Duration { get; set; }
        }

        /// <summary>
        /// å…¨éƒ¨æµ‹è¯•å®Œæˆäº‹ä»¶å‚æ•°
        /// </summary>
        public class AllTestsCompletedEventArgs : EventArgs
        {
            public List<SystemFunctionalTests.TestSuiteResult> Results { get; set; } = new();
            public TimeSpan TotalDuration { get; set; }
            public int TotalTests { get; set; }
            public int TotalPassed { get; set; }
            public int TotalFailed { get; set; }
            public double OverallSuccessRate => TotalTests > 0 ? (double)TotalPassed / TotalTests * 100 : 0;
            public bool HasCriticalFailures { get; set; }
        }

        #endregion

        #region æ„é€ å‡½æ•°

        public TestRunner()
        {
            InitializeTestSuites();
            EnsureReportDirectory();
        }

        #endregion

        #region åˆå§‹åŒ–æ–¹æ³•

        /// <summary>
        /// åˆå§‹åŒ–æµ‹è¯•å¥—ä»¶
        /// </summary>
        private void InitializeTestSuites()
        {
            // æ³¨å†Œæ‰€æœ‰æµ‹è¯•å¥—ä»¶
            _testSuites.Add(new FunctionalTestSuite());
            _testSuites.Add(new CompositeDeviceTestSuite());
            
            LogMessage("æµ‹è¯•è¿è¡Œå™¨åˆå§‹åŒ–å®Œæˆ");
            LogMessage($"å·²æ³¨å†Œ {_testSuites.Count} ä¸ªæµ‹è¯•å¥—ä»¶");
        }

        /// <summary>
        /// ç¡®ä¿æŠ¥å‘Šç›®å½•å­˜åœ¨
        /// </summary>
        private void EnsureReportDirectory()
        {
            if (!Directory.Exists(_reportOutputDirectory))
            {
                Directory.CreateDirectory(_reportOutputDirectory);
            }
        }

        #endregion

        #region å…¬å…±å±æ€§

        /// <summary>
        /// æµ‹è¯•å¥—ä»¶åˆ—è¡¨
        /// </summary>
        public IReadOnlyList<ITestSuite> TestSuites => _testSuites;

        /// <summary>
        /// æŠ¥å‘Šè¾“å‡ºç›®å½•
        /// </summary>
        public string ReportOutputDirectory
        {
            get => _reportOutputDirectory;
            set
            {
                _reportOutputDirectory = value;
                EnsureReportDirectory();
            }
        }

        #endregion

        #region ä¸»è¦æµ‹è¯•æ‰§è¡Œæ–¹æ³•

        /// <summary>
        /// è¿è¡Œæ‰€æœ‰æµ‹è¯•å¥—ä»¶
        /// </summary>
        public async Task<AllTestsCompletedEventArgs> RunAllTestsAsync()
        {
            LogMessage("=== å¼€å§‹æ‰§è¡Œæ‰€æœ‰æµ‹è¯•å¥—ä»¶ ===");
            var overallStopwatch = Stopwatch.StartNew();
            var allResults = new List<SystemFunctionalTests.TestSuiteResult>();

            var enabledSuites = _testSuites.Where(s => s.IsEnabled).ToList();
            LogMessage($"å°†æ‰§è¡Œ {enabledSuites.Count} ä¸ªå·²å¯ç”¨çš„æµ‹è¯•å¥—ä»¶");

            try
            {
                for (int i = 0; i < enabledSuites.Count; i++)
                {
                    var suite = enabledSuites[i];
                    LogMessage($"å¼€å§‹æ‰§è¡Œæµ‹è¯•å¥—ä»¶: {suite.SuiteName}");

                    // é€šçŸ¥è¿›åº¦
                    TestProgress?.Invoke(this, new TestProgressEventArgs
                    {
                        SuiteName = suite.SuiteName,
                        CurrentTest = "å‡†å¤‡ä¸­...",
                        CompletedTests = i,
                        TotalTests = enabledSuites.Count
                    });

                    var suiteStopwatch = Stopwatch.StartNew();
                    SystemFunctionalTests.TestSuiteResult result;

                    try
                    {
                        result = await suite.RunTestsAsync();
                        suiteStopwatch.Stop();

                        LogMessage($"æµ‹è¯•å¥—ä»¶ {suite.SuiteName} å®Œæˆ: {result.PassedTests}/{result.TotalTests} é€šè¿‡");
                    }
                    catch (Exception ex)
                    {
                        suiteStopwatch.Stop();
                        LogMessage($"æµ‹è¯•å¥—ä»¶ {suite.SuiteName} æ‰§è¡Œå¤±è´¥: {ex.Message}");

                        // åˆ›å»ºå¤±è´¥ç»“æœ
                        result = new SystemFunctionalTests.TestSuiteResult
                        {
                            SuiteName = suite.SuiteName,
                            TotalTests = 1,
                            PassedTests = 0,
                            FailedTests = 1,
                            TotalDuration = suiteStopwatch.Elapsed,
                            Results = new List<SystemFunctionalTests.TestResult>
                            {
                                new SystemFunctionalTests.TestResult
                                {
                                    TestSuite = suite.SuiteName,
                                    TestName = "æµ‹è¯•å¥—ä»¶æ‰§è¡Œ",
                                    Success = false,
                                    Message = $"æµ‹è¯•å¥—ä»¶æ‰§è¡Œå¤±è´¥: {ex.Message}",
                                    Exception = ex,
                                    Duration = suiteStopwatch.Elapsed,
                                    Severity = SystemFunctionalTests.TestSeverity.Critical
                                }
                            }
                        };
                    }

                    allResults.Add(result);

                    // é€šçŸ¥æµ‹è¯•å¥—ä»¶å®Œæˆ
                    TestSuiteCompleted?.Invoke(this, new TestSuiteCompletedEventArgs
                    {
                        Result = result,
                        Duration = suiteStopwatch.Elapsed
                    });

                    // ç”Ÿæˆå•ä¸ªå¥—ä»¶æŠ¥å‘Š
                    await GenerateSuiteReportAsync(result);
                }

                overallStopwatch.Stop();

                // æ±‡æ€»ç»“æœ
                var completedEventArgs = new AllTestsCompletedEventArgs
                {
                    Results = allResults,
                    TotalDuration = overallStopwatch.Elapsed,
                    TotalTests = allResults.Sum(r => r.TotalTests),
                    TotalPassed = allResults.Sum(r => r.PassedTests),
                    TotalFailed = allResults.Sum(r => r.FailedTests),
                    HasCriticalFailures = allResults.Any(r => r.HasCriticalFailures)
                };

                LogMessage("=== æ‰€æœ‰æµ‹è¯•å¥—ä»¶æ‰§è¡Œå®Œæˆ ===");
                LogMessage($"æ€»è®¡: {completedEventArgs.TotalTests}, é€šè¿‡: {completedEventArgs.TotalPassed}, å¤±è´¥: {completedEventArgs.TotalFailed}");
                LogMessage($"æ•´ä½“æˆåŠŸç‡: {completedEventArgs.OverallSuccessRate:F1}%");
                LogMessage($"æ€»è€—æ—¶: {completedEventArgs.TotalDuration.TotalSeconds:F2}ç§’");

                // ç”Ÿæˆç»¼åˆæŠ¥å‘Š
                await GenerateComprehensiveReportAsync(completedEventArgs);

                // é€šçŸ¥å…¨éƒ¨æµ‹è¯•å®Œæˆ
                AllTestsCompleted?.Invoke(this, completedEventArgs);

                return completedEventArgs;
            }
            catch (Exception ex)
            {
                LogMessage($"æµ‹è¯•æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿä¸¥é‡é”™è¯¯: {ex.Message}");
                throw;
            }
        }

        /// <summary>
        /// è¿è¡ŒæŒ‡å®šçš„æµ‹è¯•å¥—ä»¶
        /// </summary>
        public async Task<SystemFunctionalTests.TestSuiteResult> RunTestSuiteAsync(string suiteName)
        {
            var suite = _testSuites.FirstOrDefault(s => s.SuiteName == suiteName);
            if (suite == null)
            {
                throw new ArgumentException($"æœªæ‰¾åˆ°æµ‹è¯•å¥—ä»¶: {suiteName}");
            }

            if (!suite.IsEnabled)
            {
                throw new InvalidOperationException($"æµ‹è¯•å¥—ä»¶ {suiteName} å·²ç¦ç”¨");
            }

            LogMessage($"å¼€å§‹æ‰§è¡Œå•ä¸ªæµ‹è¯•å¥—ä»¶: {suiteName}");
            var stopwatch = Stopwatch.StartNew();

            var result = await suite.RunTestsAsync();
            stopwatch.Stop();

            LogMessage($"æµ‹è¯•å¥—ä»¶ {suiteName} å®Œæˆ: {result.PassedTests}/{result.TotalTests} é€šè¿‡, è€—æ—¶: {stopwatch.Elapsed.TotalSeconds:F2}ç§’");

            // ç”Ÿæˆå•ä¸ªå¥—ä»¶æŠ¥å‘Š
            await GenerateSuiteReportAsync(result);

            return result;
        }

        /// <summary>
        /// è¿è¡Œå¿«é€ŸéªŒè¯æµ‹è¯•
        /// </summary>
        public async Task<QuickTestResult> RunQuickValidationTestsAsync()
        {
            LogMessage("å¼€å§‹æ‰§è¡Œå¿«é€ŸéªŒè¯æµ‹è¯•");
            var stopwatch = Stopwatch.StartNew();

            var quickTests = new List<Func<Task<(string name, bool success, string message)>>>
            {
                // æ ¸å¿ƒç»„ä»¶å¿«é€Ÿæ£€æŸ¥
                async () =>
                {
                    try
                    {
                        var templateManager = Templates.TemplateManager.Instance;
                        var templates = templateManager.GetAvailableTemplates();
                        return ("æ¨¡æ¿ç®¡ç†å™¨", templates.Any(), $"å‘ç° {templates.Count} ä¸ªæ¨¡æ¿");
                    }
                    catch (Exception ex)
                    {
                        return ("æ¨¡æ¿ç®¡ç†å™¨", false, $"åˆå§‹åŒ–å¤±è´¥: {ex.Message}");
                    }
                },

                // è®¾å¤‡ç®¡ç†å™¨å¿«é€Ÿæ£€æŸ¥
                async () =>
                {
                    try
                    {
                        var deviceManager = Devices.CompositeDeviceManager.Instance;
                        var isInitialized = deviceManager.IsInitialized;
                        return ("è®¾å¤‡ç®¡ç†å™¨", isInitialized, $"åˆå§‹åŒ–çŠ¶æ€: {isInitialized}");
                    }
                    catch (Exception ex)
                    {
                        return ("è®¾å¤‡ç®¡ç†å™¨", false, $"æ£€æŸ¥å¤±è´¥: {ex.Message}");
                    }
                },

                // é…ç½®ç®¡ç†å™¨å¿«é€Ÿæ£€æŸ¥
                async () =>
                {
                    try
                    {
                        var configManager = Config.ApplicationConfiguration.Instance;
                        var settings = configManager.GetCurrentSettings();
                        return ("é…ç½®ç®¡ç†å™¨", settings != null, $"é…ç½®çŠ¶æ€: {(settings != null ? "å·²åŠ è½½" : "æœªåŠ è½½")}");
                    }
                    catch (Exception ex)
                    {
                        return ("é…ç½®ç®¡ç†å™¨", false, $"æ£€æŸ¥å¤±è´¥: {ex.Message}");
                    }
                },

                // ç®€å•ä»£ç ç”Ÿæˆæµ‹è¯•
                async () =>
                {
                    try
                    {
                        var templateManager = Templates.TemplateManager.Instance;
                        var testPoint = new AutomaticGeneration_ST.Models.Point
                        {
                            Id = "QUICK_TEST",
                            Name = "QuickTest",
                            Type = "AI",
                            HMITagName = "QUICK_TAG"
                        };
                        var code = await templateManager.RenderTemplateAsync("AI", testPoint);
                        var success = !string.IsNullOrEmpty(code) && code.Contains("QUICK_TAG");
                        return ("ä»£ç ç”Ÿæˆ", success, $"ç”ŸæˆçŠ¶æ€: {(success ? "æˆåŠŸ" : "å¤±è´¥")}");
                    }
                    catch (Exception ex)
                    {
                        return ("ä»£ç ç”Ÿæˆ", false, $"ç”Ÿæˆå¤±è´¥: {ex.Message}");
                    }
                }
            };

            var results = new List<(string name, bool success, string message)>();

            foreach (var test in quickTests)
            {
                try
                {
                    var result = await test();
                    results.Add(result);
                    LogMessage($"å¿«é€Ÿæµ‹è¯• - {result.name}: {(result.success ? "é€šè¿‡" : "å¤±è´¥")} - {result.message}");
                }
                catch (Exception ex)
                {
                    results.Add(("æœªçŸ¥æµ‹è¯•", false, $"æ‰§è¡Œå¼‚å¸¸: {ex.Message}"));
                }
            }

            stopwatch.Stop();

            var quickResult = new QuickTestResult
            {
                TotalTests = results.Count,
                PassedTests = results.Count(r => r.success),
                FailedTests = results.Count(r => !r.success),
                Duration = stopwatch.Elapsed,
                Results = results,
                OverallSuccess = results.All(r => r.success)
            };

            LogMessage($"å¿«é€ŸéªŒè¯æµ‹è¯•å®Œæˆ: {quickResult.PassedTests}/{quickResult.TotalTests} é€šè¿‡, è€—æ—¶: {quickResult.Duration.TotalMilliseconds:F0}ms");

            return quickResult;
        }

        #endregion

        #region å¿«é€Ÿæµ‹è¯•ç»“æœç±»

        /// <summary>
        /// å¿«é€Ÿæµ‹è¯•ç»“æœ
        /// </summary>
        public class QuickTestResult
        {
            public int TotalTests { get; set; }
            public int PassedTests { get; set; }
            public int FailedTests { get; set; }
            public TimeSpan Duration { get; set; }
            public List<(string name, bool success, string message)> Results { get; set; } = new();
            public bool OverallSuccess { get; set; }
            public double SuccessRate => TotalTests > 0 ? (double)PassedTests / TotalTests * 100 : 0;
        }

        #endregion

        #region æŠ¥å‘Šç”Ÿæˆæ–¹æ³•

        /// <summary>
        /// ç”Ÿæˆå•ä¸ªæµ‹è¯•å¥—ä»¶æŠ¥å‘Š
        /// </summary>
        private async Task GenerateSuiteReportAsync(SystemFunctionalTests.TestSuiteResult result)
        {
            try
            {
                var timestamp = DateTime.Now.ToString("yyyyMMdd_HHmmss");
                var fileName = $"{result.SuiteName.Replace(" ", "_")}_{timestamp}.html";
                var filePath = Path.Combine(_reportOutputDirectory, fileName);

                var htmlContent = GenerateHtmlReport(result);
                await File.WriteAllTextAsync(filePath, htmlContent, Encoding.UTF8);

                LogMessage($"æµ‹è¯•å¥—ä»¶æŠ¥å‘Šå·²ç”Ÿæˆ: {filePath}");
            }
            catch (Exception ex)
            {
                LogMessage($"ç”Ÿæˆæµ‹è¯•å¥—ä»¶æŠ¥å‘Šå¤±è´¥: {ex.Message}");
            }
        }

        /// <summary>
        /// ç”Ÿæˆç»¼åˆæµ‹è¯•æŠ¥å‘Š
        /// </summary>
        private async Task GenerateComprehensiveReportAsync(AllTestsCompletedEventArgs results)
        {
            try
            {
                var timestamp = DateTime.Now.ToString("yyyyMMdd_HHmmss");
                
                // ç”ŸæˆHTMLæŠ¥å‘Š
                var htmlFileName = $"Comprehensive_Test_Report_{timestamp}.html";
                var htmlFilePath = Path.Combine(_reportOutputDirectory, htmlFileName);
                var htmlContent = GenerateComprehensiveHtmlReport(results);
                await File.WriteAllTextAsync(htmlFilePath, htmlContent, Encoding.UTF8);

                // ç”Ÿæˆæ–‡æœ¬æŠ¥å‘Š
                var textFileName = $"Comprehensive_Test_Report_{timestamp}.txt";
                var textFilePath = Path.Combine(_reportOutputDirectory, textFileName);
                var textContent = GenerateComprehensiveTextReport(results);
                await File.WriteAllTextAsync(textFilePath, textContent, Encoding.UTF8);

                // ç”ŸæˆJSONæŠ¥å‘Šï¼ˆç”¨äºç¨‹åºå¤„ç†ï¼‰
                var jsonFileName = $"Comprehensive_Test_Report_{timestamp}.json";
                var jsonFilePath = Path.Combine(_reportOutputDirectory, jsonFileName);
                var jsonContent = Newtonsoft.Json.JsonConvert.SerializeObject(results, Newtonsoft.Json.Formatting.Indented);
                await File.WriteAllTextAsync(jsonFilePath, jsonContent, Encoding.UTF8);

                LogMessage($"ç»¼åˆæµ‹è¯•æŠ¥å‘Šå·²ç”Ÿæˆ:");
                LogMessage($"  HTMLæŠ¥å‘Š: {htmlFilePath}");
                LogMessage($"  æ–‡æœ¬æŠ¥å‘Š: {textFilePath}");
                LogMessage($"  JSONæŠ¥å‘Š: {jsonFilePath}");
            }
            catch (Exception ex)
            {
                LogMessage($"ç”Ÿæˆç»¼åˆæµ‹è¯•æŠ¥å‘Šå¤±è´¥: {ex.Message}");
            }
        }

        /// <summary>
        /// ç”ŸæˆHTMLæ ¼å¼çš„å•ä¸ªæµ‹è¯•å¥—ä»¶æŠ¥å‘Š
        /// </summary>
        private string GenerateHtmlReport(SystemFunctionalTests.TestSuiteResult result)
        {
            var sb = new StringBuilder();
            
            sb.AppendLine("<!DOCTYPE html>");
            sb.AppendLine("<html lang='zh-CN'>");
            sb.AppendLine("<head>");
            sb.AppendLine("    <meta charset='UTF-8'>");
            sb.AppendLine("    <meta name='viewport' content='width=device-width, initial-scale=1.0'>");
            sb.AppendLine($"    <title>{result.SuiteName} - æµ‹è¯•æŠ¥å‘Š</title>");
            sb.AppendLine("    <style>");
            sb.AppendLine("        body { font-family: 'Microsoft YaHei', Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }");
            sb.AppendLine("        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }");
            sb.AppendLine("        h1 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; }");
            sb.AppendLine("        h2 { color: #34495e; margin-top: 30px; }");
            sb.AppendLine("        .summary { display: flex; justify-content: space-around; margin: 20px 0; }");
            sb.AppendLine("        .summary-item { text-align: center; padding: 15px; background: #ecf0f1; border-radius: 5px; }");
            sb.AppendLine("        .summary-item h3 { margin: 0; font-size: 24px; }");
            sb.AppendLine("        .summary-item p { margin: 5px 0 0; color: #7f8c8d; }");
            sb.AppendLine("        .test-pass { color: #27ae60; }");
            sb.AppendLine("        .test-fail { color: #e74c3c; }");
            sb.AppendLine("        .test-critical { color: #e74c3c; font-weight: bold; }");
            sb.AppendLine("        table { width: 100%; border-collapse: collapse; margin: 20px 0; }");
            sb.AppendLine("        th, td { border: 1px solid #bdc3c7; padding: 10px; text-align: left; }");
            sb.AppendLine("        th { background-color: #34495e; color: white; }");
            sb.AppendLine("        tr:nth-child(even) { background-color: #f8f9fa; }");
            sb.AppendLine("        .progress-bar { width: 100%; background-color: #ecf0f1; border-radius: 10px; overflow: hidden; }");
            sb.AppendLine("        .progress-fill { height: 20px; background-color: #3498db; transition: width 0.3s ease; }");
            sb.AppendLine("        .details { margin-top: 10px; padding: 10px; background: #f8f9fa; border-left: 4px solid #3498db; }");
            sb.AppendLine("    </style>");
            sb.AppendLine("</head>");
            sb.AppendLine("<body>");
            sb.AppendLine("    <div class='container'>");
            
            // æ ‡é¢˜å’ŒåŸºæœ¬ä¿¡æ¯
            sb.AppendLine($"        <h1>{result.SuiteName} - æµ‹è¯•æŠ¥å‘Š</h1>");
            sb.AppendLine($"        <p><strong>ç”Ÿæˆæ—¶é—´:</strong> {DateTime.Now:yyyy-MM-dd HH:mm:ss}</p>");
            sb.AppendLine($"        <p><strong>æ‰§è¡Œæ—¶é•¿:</strong> {result.TotalDuration.TotalSeconds:F2} ç§’</p>");
            
            // æ‘˜è¦ç»Ÿè®¡
            sb.AppendLine("        <div class='summary'>");
            sb.AppendLine($"            <div class='summary-item'>");
            sb.AppendLine($"                <h3>{result.TotalTests}</h3>");
            sb.AppendLine($"                <p>æ€»æµ‹è¯•æ•°</p>");
            sb.AppendLine($"            </div>");
            sb.AppendLine($"            <div class='summary-item'>");
            sb.AppendLine($"                <h3 class='test-pass'>{result.PassedTests}</h3>");
            sb.AppendLine($"                <p>é€šè¿‡æµ‹è¯•</p>");
            sb.AppendLine($"            </div>");
            sb.AppendLine($"            <div class='summary-item'>");
            sb.AppendLine($"                <h3 class='test-fail'>{result.FailedTests}</h3>");
            sb.AppendLine($"                <p>å¤±è´¥æµ‹è¯•</p>");
            sb.AppendLine($"            </div>");
            sb.AppendLine($"            <div class='summary-item'>");
            sb.AppendLine($"                <h3>{result.SuccessRate:F1}%</h3>");
            sb.AppendLine($"                <p>æˆåŠŸç‡</p>");
            sb.AppendLine($"            </div>");
            sb.AppendLine("        </div>");
            
            // è¿›åº¦æ¡
            sb.AppendLine("        <div class='progress-bar'>");
            sb.AppendLine($"            <div class='progress-fill' style='width: {result.SuccessRate}%'></div>");
            sb.AppendLine("        </div>");
            
            // è¯¦ç»†æµ‹è¯•ç»“æœ
            sb.AppendLine("        <h2>è¯¦ç»†æµ‹è¯•ç»“æœ</h2>");
            sb.AppendLine("        <table>");
            sb.AppendLine("            <thead>");
            sb.AppendLine("                <tr>");
            sb.AppendLine("                    <th>æµ‹è¯•å¥—ä»¶</th>");
            sb.AppendLine("                    <th>æµ‹è¯•åç§°</th>");
            sb.AppendLine("                    <th>ç»“æœ</th>");
            sb.AppendLine("                    <th>è€—æ—¶(ms)</th>");
            sb.AppendLine("                    <th>æ¶ˆæ¯</th>");
            sb.AppendLine("                </tr>");
            sb.AppendLine("            </thead>");
            sb.AppendLine("            <tbody>");
            
            foreach (var test in result.Results)
            {
                var statusClass = test.Success ? "test-pass" : (test.Severity == SystemFunctionalTests.TestSeverity.Critical ? "test-critical" : "test-fail");
                var statusText = test.Success ? "é€šè¿‡" : "å¤±è´¥";
                
                sb.AppendLine("                <tr>");
                sb.AppendLine($"                    <td>{test.TestSuite}</td>");
                sb.AppendLine($"                    <td>{test.TestName}</td>");
                sb.AppendLine($"                    <td class='{statusClass}'>{statusText}</td>");
                sb.AppendLine($"                    <td>{test.Duration.TotalMilliseconds:F0}</td>");
                sb.AppendLine($"                    <td>{test.Message}</td>");
                sb.AppendLine("                </tr>");
                
                // å¦‚æœæœ‰è¯¦ç»†æ•°æ®ï¼Œæ·»åŠ è¯¦æƒ…è¡Œ
                if (test.Data.Any())
                {
                    sb.AppendLine("                <tr>");
                    sb.AppendLine("                    <td colspan='5'>");
                    sb.AppendLine("                        <div class='details'>");
                    sb.AppendLine("                            <strong>æµ‹è¯•æ•°æ®:</strong><br>");
                    foreach (var kvp in test.Data.Take(10)) // é™åˆ¶æ˜¾ç¤ºå‰10ä¸ªæ•°æ®
                    {
                        sb.AppendLine($"                            {kvp.Key}: {kvp.Value}<br>");
                    }
                    sb.AppendLine("                        </div>");
                    sb.AppendLine("                    </td>");
                    sb.AppendLine("                </tr>");
                }
            }
            
            sb.AppendLine("            </tbody>");
            sb.AppendLine("        </table>");
            
            sb.AppendLine("    </div>");
            sb.AppendLine("</body>");
            sb.AppendLine("</html>");
            
            return sb.ToString();
        }

        /// <summary>
        /// ç”Ÿæˆç»¼åˆHTMLæŠ¥å‘Š
        /// </summary>
        private string GenerateComprehensiveHtmlReport(AllTestsCompletedEventArgs results)
        {
            var sb = new StringBuilder();
            
            sb.AppendLine("<!DOCTYPE html>");
            sb.AppendLine("<html lang='zh-CN'>");
            sb.AppendLine("<head>");
            sb.AppendLine("    <meta charset='UTF-8'>");
            sb.AppendLine("    <meta name='viewport' content='width=device-width, initial-scale=1.0'>");
            sb.AppendLine("    <title>STè‡ªåŠ¨ç”Ÿæˆå™¨ - ç»¼åˆæµ‹è¯•æŠ¥å‘Š</title>");
            sb.AppendLine("    <style>");
            // CSSæ ·å¼ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
            sb.AppendLine("        body { font-family: 'Microsoft YaHei', Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }");
            sb.AppendLine("        .container { max-width: 1400px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }");
            sb.AppendLine("        h1 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 15px; text-align: center; }");
            sb.AppendLine("        .overall-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0; }");
            sb.AppendLine("        .summary-card { padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px; text-align: center; }");
            sb.AppendLine("        .summary-card h3 { margin: 0; font-size: 28px; }");
            sb.AppendLine("        .summary-card p { margin: 10px 0 0; opacity: 0.9; }");
            sb.AppendLine("        .suite-summary { margin: 30px 0; }");
            sb.AppendLine("        .suite-card { background: #f8f9fa; border-left: 5px solid #3498db; padding: 15px; margin: 10px 0; border-radius: 5px; }");
            sb.AppendLine("        .suite-card.failed { border-left-color: #e74c3c; }");
            sb.AppendLine("        .progress-container { margin: 20px 0; }");
            sb.AppendLine("        .progress-bar { width: 100%; height: 25px; background-color: #ecf0f1; border-radius: 12px; overflow: hidden; position: relative; }");
            sb.AppendLine("        .progress-fill { height: 100%; background: linear-gradient(90deg, #56ab2f 0%, #a8e6cf 100%); transition: width 0.5s ease; }");
            sb.AppendLine("        .progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold; color: #2c3e50; }");
            sb.AppendLine("    </style>");
            sb.AppendLine("</head>");
            sb.AppendLine("<body>");
            sb.AppendLine("    <div class='container'>");
            
            // ä¸»æ ‡é¢˜
            sb.AppendLine("        <h1>STè‡ªåŠ¨ç”Ÿæˆå™¨ç³»ç»Ÿ - ç»¼åˆæµ‹è¯•æŠ¥å‘Š</h1>");
            sb.AppendLine($"        <p style='text-align: center; color: #7f8c8d; font-size: 16px;'>ç”Ÿæˆæ—¶é—´: {DateTime.Now:yyyy-MM-dd HH:mm:ss} | æ€»æ‰§è¡Œæ—¶é•¿: {results.TotalDuration.TotalSeconds:F2} ç§’</p>");
            
            // æ•´ä½“ç»Ÿè®¡
            sb.AppendLine("        <div class='overall-summary'>");
            sb.AppendLine("            <div class='summary-card'>");
            sb.AppendLine($"                <h3>{results.Results.Count}</h3>");
            sb.AppendLine("                <p>æµ‹è¯•å¥—ä»¶</p>");
            sb.AppendLine("            </div>");
            sb.AppendLine("            <div class='summary-card'>");
            sb.AppendLine($"                <h3>{results.TotalTests}</h3>");
            sb.AppendLine("                <p>æ€»æµ‹è¯•æ•°</p>");
            sb.AppendLine("            </div>");
            sb.AppendLine("            <div class='summary-card'>");
            sb.AppendLine($"                <h3>{results.TotalPassed}</h3>");
            sb.AppendLine("                <p>é€šè¿‡æµ‹è¯•</p>");
            sb.AppendLine("            </div>");
            sb.AppendLine("            <div class='summary-card'>");
            sb.AppendLine($"                <h3>{results.TotalFailed}</h3>");
            sb.AppendLine("                <p>å¤±è´¥æµ‹è¯•</p>");
            sb.AppendLine("            </div>");
            sb.AppendLine("            <div class='summary-card'>");
            sb.AppendLine($"                <h3>{results.OverallSuccessRate:F1}%</h3>");
            sb.AppendLine("                <p>æ•´ä½“æˆåŠŸç‡</p>");
            sb.AppendLine("            </div>");
            sb.AppendLine("        </div>");
            
            // æ•´ä½“è¿›åº¦æ¡
            sb.AppendLine("        <div class='progress-container'>");
            sb.AppendLine("            <h3>æ•´ä½“æµ‹è¯•è¿›åº¦</h3>");
            sb.AppendLine("            <div class='progress-bar'>");
            sb.AppendLine($"                <div class='progress-fill' style='width: {results.OverallSuccessRate}%'></div>");
            sb.AppendLine($"                <div class='progress-text'>{results.TotalPassed}/{results.TotalTests} é€šè¿‡ ({results.OverallSuccessRate:F1}%)</div>");
            sb.AppendLine("            </div>");
            sb.AppendLine("        </div>");
            
            // å„æµ‹è¯•å¥—ä»¶è¯¦æƒ…
            sb.AppendLine("        <div class='suite-summary'>");
            sb.AppendLine("            <h2>æµ‹è¯•å¥—ä»¶è¯¦æƒ…</h2>");
            
            foreach (var suite in results.Results)
            {
                var cardClass = suite.SuccessRate < 100 ? "suite-card failed" : "suite-card";
                sb.AppendLine($"            <div class='{cardClass}'>");
                sb.AppendLine($"                <h4>{suite.SuiteName}</h4>");
                sb.AppendLine($"                <p><strong>æµ‹è¯•ç»“æœ:</strong> {suite.PassedTests}/{suite.TotalTests} é€šè¿‡ ({suite.SuccessRate:F1}%)</p>");
                sb.AppendLine($"                <p><strong>æ‰§è¡Œæ—¶é•¿:</strong> {suite.TotalDuration.TotalSeconds:F2} ç§’</p>");
                
                if (suite.FailedTests > 0)
                {
                    sb.AppendLine("                <p><strong>å¤±è´¥æµ‹è¯•:</strong></p>");
                    sb.AppendLine("                <ul>");
                    foreach (var failedTest in suite.Results.Where(r => !r.Success).Take(5))
                    {
                        sb.AppendLine($"                    <li>{failedTest.TestName}: {failedTest.Message}</li>");
                    }
                    if (suite.Results.Count(r => !r.Success) > 5)
                    {
                        sb.AppendLine($"                    <li>... è¿˜æœ‰ {suite.Results.Count(r => !r.Success) - 5} ä¸ªå¤±è´¥æµ‹è¯•</li>");
                    }
                    sb.AppendLine("                </ul>");
                }
                
                sb.AppendLine("            </div>");
            }
            
            sb.AppendLine("        </div>");
            
            // å…³é”®å¤±è´¥æé†’
            if (results.HasCriticalFailures)
            {
                sb.AppendLine("        <div style='background: #ffebee; border: 2px solid #f44336; padding: 20px; margin: 20px 0; border-radius: 5px;'>");
                sb.AppendLine("            <h3 style='color: #d32f2f; margin-top: 0;'>âš ï¸ å‘ç°å…³é”®å¤±è´¥</h3>");
                sb.AppendLine("            <p>ç³»ç»Ÿæ£€æµ‹åˆ°ä¸€äº›å…³é”®åŠŸèƒ½æµ‹è¯•å¤±è´¥ï¼Œè¯·ä¼˜å…ˆå¤„ç†è¿™äº›é—®é¢˜ä»¥ç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§ã€‚</p>");
                sb.AppendLine("        </div>");
            }
            
            sb.AppendLine("    </div>");
            sb.AppendLine("</body>");
            sb.AppendLine("</html>");
            
            return sb.ToString();
        }

        /// <summary>
        /// ç”Ÿæˆç»¼åˆæ–‡æœ¬æŠ¥å‘Š
        /// </summary>
        private string GenerateComprehensiveTextReport(AllTestsCompletedEventArgs results)
        {
            var sb = new StringBuilder();
            
            sb.AppendLine("========================================");
            sb.AppendLine("STè‡ªåŠ¨ç”Ÿæˆå™¨ç³»ç»Ÿ - ç»¼åˆæµ‹è¯•æŠ¥å‘Š");
            sb.AppendLine("========================================");
            sb.AppendLine($"ç”Ÿæˆæ—¶é—´: {DateTime.Now:yyyy-MM-dd HH:mm:ss}");
            sb.AppendLine($"æ€»æ‰§è¡Œæ—¶é•¿: {results.TotalDuration.TotalSeconds:F2} ç§’");
            sb.AppendLine();
            
            // æ•´ä½“ç»Ÿè®¡
            sb.AppendLine("æ•´ä½“ç»Ÿè®¡:");
            sb.AppendLine("----------------------------------------");
            sb.AppendLine($"æµ‹è¯•å¥—ä»¶æ•°é‡: {results.Results.Count}");
            sb.AppendLine($"æ€»æµ‹è¯•æ•°é‡: {results.TotalTests}");
            sb.AppendLine($"é€šè¿‡æµ‹è¯•: {results.TotalPassed}");
            sb.AppendLine($"å¤±è´¥æµ‹è¯•: {results.TotalFailed}");
            sb.AppendLine($"æ•´ä½“æˆåŠŸç‡: {results.OverallSuccessRate:F1}%");
            sb.AppendLine($"å…³é”®å¤±è´¥: {(results.HasCriticalFailures ? "æ˜¯" : "å¦")}");
            sb.AppendLine();
            
            // å„æµ‹è¯•å¥—ä»¶è¯¦æƒ…
            sb.AppendLine("æµ‹è¯•å¥—ä»¶è¯¦æƒ…:");
            sb.AppendLine("----------------------------------------");
            foreach (var suite in results.Results)
            {
                sb.AppendLine($"\n[{suite.SuiteName}]");
                sb.AppendLine($"  æµ‹è¯•ç»“æœ: {suite.PassedTests}/{suite.TotalTests} ({suite.SuccessRate:F1}%)");
                sb.AppendLine($"  æ‰§è¡Œæ—¶é•¿: {suite.TotalDuration.TotalSeconds:F2} ç§’");
                sb.AppendLine($"  å¤±è´¥æµ‹è¯•: {suite.FailedTests}");
                
                if (suite.FailedTests > 0)
                {
                    sb.AppendLine("  å¤±è´¥è¯¦æƒ…:");
                    foreach (var failedTest in suite.Results.Where(r => !r.Success).Take(3))
                    {
                        sb.AppendLine($"    - {failedTest.TestName}: {failedTest.Message}");
                    }
                    if (suite.Results.Count(r => !r.Success) > 3)
                    {
                        sb.AppendLine($"    ... è¿˜æœ‰ {suite.Results.Count(r => !r.Success) - 3} ä¸ªå¤±è´¥æµ‹è¯•");
                    }
                }
            }
            
            // å…³é”®å¤±è´¥æ±‡æ€»
            if (results.HasCriticalFailures)
            {
                sb.AppendLine("\nå…³é”®å¤±è´¥æ±‡æ€»:");
                sb.AppendLine("----------------------------------------");
                var criticalFailures = results.Results
                    .SelectMany(r => r.Results)
                    .Where(t => !t.Success && t.Severity == SystemFunctionalTests.TestSeverity.Critical)
                    .ToList();
                
                foreach (var failure in criticalFailures)
                {
                    sb.AppendLine($"[{failure.TestSuite}] {failure.TestName}");
                    sb.AppendLine($"  é”™è¯¯: {failure.Message}");
                    if (failure.Exception != null)
                    {
                        sb.AppendLine($"  å¼‚å¸¸: {failure.Exception.GetType().Name}");
                    }
                    sb.AppendLine();
                }
            }
            
            // å»ºè®®å’Œæ€»ç»“
            sb.AppendLine("æµ‹è¯•æ€»ç»“å’Œå»ºè®®:");
            sb.AppendLine("----------------------------------------");
            
            if (results.OverallSuccessRate >= 95)
            {
                sb.AppendLine("âœ… ç³»ç»Ÿæ•´ä½“è¡¨ç°ä¼˜ç§€ï¼Œæ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸å·¥ä½œã€‚");
            }
            else if (results.OverallSuccessRate >= 80)
            {
                sb.AppendLine("âš ï¸ ç³»ç»ŸåŸºæœ¬åŠŸèƒ½æ­£å¸¸ï¼Œä½†å­˜åœ¨ä¸€äº›éœ€è¦æ”¹è¿›çš„åœ°æ–¹ã€‚");
            }
            else
            {
                sb.AppendLine("âŒ ç³»ç»Ÿå­˜åœ¨è¾ƒå¤šé—®é¢˜ï¼Œéœ€è¦é‡ç‚¹å…³æ³¨å’Œä¿®å¤å¤±è´¥çš„æµ‹è¯•é¡¹ã€‚");
            }
            
            if (results.HasCriticalFailures)
            {
                sb.AppendLine("ğŸš¨ å‘ç°å…³é”®åŠŸèƒ½å¤±è´¥ï¼Œå»ºè®®ä¼˜å…ˆä¿®å¤è¿™äº›é—®é¢˜ã€‚");
            }
            
            sb.AppendLine($"\nå¹³å‡æµ‹è¯•æ‰§è¡Œæ—¶é—´: {results.TotalDuration.TotalMilliseconds / results.TotalTests:F2} ms/æµ‹è¯•");
            sb.AppendLine($"ç³»ç»Ÿç¨³å®šæ€§è¯„ä¼°: {(results.HasCriticalFailures ? "éœ€è¦æ”¹è¿›" : "è‰¯å¥½")}");
            
            return sb.ToString();
        }

        #endregion

        #region å·¥å…·æ–¹æ³•

        /// <summary>
        /// è®°å½•æ—¥å¿—æ¶ˆæ¯
        /// </summary>
        private void LogMessage(string message)
        {
            var timestamp = DateTime.Now.ToString("HH:mm:ss.fff");
            var logEntry = $"[{timestamp}] {message}";
            _executionLog.AppendLine(logEntry);
            
            // ä¹Ÿå¯ä»¥è¾“å‡ºåˆ°æ§åˆ¶å°æˆ–å…¶ä»–æ—¥å¿—ç³»ç»Ÿ
            Console.WriteLine(logEntry);
        }

        /// <summary>
        /// å¯ç”¨æˆ–ç¦ç”¨æµ‹è¯•å¥—ä»¶
        /// </summary>
        public void SetTestSuiteEnabled(string suiteName, bool enabled)
        {
            var suite = _testSuites.FirstOrDefault(s => s.SuiteName == suiteName);
            if (suite != null)
            {
                suite.IsEnabled = enabled;
                LogMessage($"æµ‹è¯•å¥—ä»¶ {suiteName} å·²{(enabled ? "å¯ç”¨" : "ç¦ç”¨")}");
            }
        }

        /// <summary>
        /// è·å–æ‰§è¡Œæ—¥å¿—
        /// </summary>
        public string GetExecutionLog()
        {
            return _executionLog.ToString();
        }

        /// <summary>
        /// æ¸…é™¤æ‰§è¡Œæ—¥å¿—
        /// </summary>
        public void ClearExecutionLog()
        {
            _executionLog.Clear();
        }

        #endregion

        #region èµ„æºé‡Šæ”¾

        /// <summary>
        /// é‡Šæ”¾èµ„æº
        /// </summary>
        public void Dispose()
        {
            _testSuites.Clear();
            _globalTestContext.Clear();
            _executionLog.Clear();
        }

        #endregion
    }
}